generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(uuid())
  email                String             @unique
  passwordHash         String
  name                 String
  phone                String?
  appType              AppType
  role                 String
  status               UserStatus         @default(ACTIVE)
  departmentIds        String[]
  allDepartmentsAccess Boolean            @default(false)
  clientRoleId         String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  lastLoginAt          DateTime?
  auditReports         AuditReport[]      @relation("AuditorReports")
  reviewedReports      AuditReport[]      @relation("ReviewerReports")
  refreshTokens        RefreshToken[]
  reportComments       ReportComment[]
  syncQueueItems       SyncQueue[]
  schedules            LocationSchedule[] @relation("ScheduleAuditors")
  clientRole           ClientRole?        @relation(fields: [clientRoleId], references: [id])
  assignedLocationId   String?
  assignedLocation     Location?          @relation("UserAssignedLocation", fields: [assignedLocationId], references: [id])
  QRGenerationJob      QRGenerationJob[]
  QRBindingRecord      QRBindingRecord[]

  @@index([email])
  @@index([appType])
  @@index([assignedLocationId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Location {
  id             String             @id @default(uuid())
  description    String?
  path           String
  depth          Int
  levelLabel     String
  parentId       String?
  isLocked       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  locationCode   String             @unique
  locationName   String
  auditReports   AuditReport[]
  inventoryItems InventoryItem[]
  parent         Location?          @relation("LocationHierarchy", fields: [parentId], references: [id])
  children       Location[]         @relation("LocationHierarchy")
  schedules      LocationSchedule[]
  assignedUsers  User[]             @relation("UserAssignedLocation")

  @@index([path])
  @@index([parentId])
  @@index([locationCode])
}

model LocationSchedule {
  id               String   @id @default(uuid())
  locationId       String
  scheduledDate    DateTime @db.Date
  isOverrideLocked Boolean  @default(false)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  location         Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  assignedAuditors User[]   @relation("ScheduleAuditors")

  @@unique([locationId, scheduledDate])
  @@index([scheduledDate])
}

model Department {
  id             String          @id @default(uuid())
  code           String          @unique
  name           String
  description    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  inventoryItems InventoryItem[]

  @@index([code])
}

model AssetCategory {
  id                     String                  @id @default(uuid())
  code                   String                  @unique
  name                   String
  description            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  customFieldDefinitions CustomFieldDefinition[]
  inventoryItems         InventoryItem[]

  @@index([code])
}

model CustomFieldDefinition {
  id         String          @id @default(uuid())
  name       String
  label      String
  type       CustomFieldType
  required   Boolean         @default(false)
  options    Json?
  order      Int             @default(0)
  categoryId String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  category   AssetCategory?  @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
}

model InventoryItem {
  id                      String            @id @default(uuid())
  locationId              String
  departmentId            String?
  categoryId              String?
  customFields            Json              @default("{}")
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  profitCenter            String?
  subCategory             String?
  unitOfMeasure           String?
  accumulatedDepreciation Decimal?          @db.Decimal(15, 2)
  acquisitionCost         Decimal?          @db.Decimal(15, 2)
  assetDescription        String?
  assetName               String
  assetNumber             String            @unique
  capitalizationDate      DateTime?
  inventoryStatus         String?
  netBookValue            Decimal?          @db.Decimal(15, 2)
  quantityAsPerBooks      Int?
  auditFindings           AuditFinding[]
  category                AssetCategory?    @relation(fields: [categoryId], references: [id])
  department              Department?       @relation(fields: [departmentId], references: [id])
  location                Location          @relation(fields: [locationId], references: [id])
  QRBindingRecord         QRBindingRecord[]

  @@index([locationId])
  @@index([departmentId])
  @@index([assetNumber])
}

model QRCodeTag {
  id           String           @id @default(uuid())
  code         String           @unique
  url          String?          @unique
  hashString   String?          @unique
  status       QRTagStatus      @default(UNASSIGNED)
  batchId      String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  retiredAt    DateTime?
  qrBatch      QRBatch?         @relation(fields: [batchId], references: [id])
  binding      QRBindingRecord?

  @@index([code])
  @@index([status])
  @@index([batchId])
}

model AuditReport {
  id          String            @id @default(uuid())
  locationId  String
  auditorId   String
  status      AuditReportStatus @default(DRAFT)
  submittedAt DateTime?
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  findings    AuditFinding[]
  auditor     User              @relation("AuditorReports", fields: [auditorId], references: [id])
  location    Location          @relation(fields: [locationId], references: [id])
  reviewer    User?             @relation("ReviewerReports", fields: [reviewedBy], references: [id])
  comments    ReportComment[]

  @@index([locationId])
  @@index([auditorId])
  @@index([status])
}

model AuditFinding {
  id                String             @id @default(uuid())
  reportId          String
  itemId            String
  status            VerificationStatus @default(PENDING)
  condition         ItemCondition?
  notes             String?
  geoLat            Float?
  geoLng            Float?
  geoAccuracy       Float?
  geoTimestamp      DateTime?
  customFieldValues Json               @default("{}")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  item              InventoryItem      @relation(fields: [itemId], references: [id])
  report            AuditReport        @relation(fields: [reportId], references: [id], onDelete: Cascade)
  photos            AuditPhoto[]

  @@unique([reportId, itemId])
  @@index([reportId])
  @@index([itemId])
}

model AuditPhoto {
  id               String       @id @default(uuid())
  findingId        String
  storagePath      String
  originalFilename String
  mimeType         String
  sizeBytes        Int
  geoLat           Float?
  geoLng           Float?
  capturedAt       DateTime?
  createdAt        DateTime     @default(now())
  finding          AuditFinding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  @@index([findingId])
}

model ReportComment {
  id        String      @id @default(uuid())
  reportId  String
  itemId    String?
  authorId  String
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  author    User        @relation(fields: [authorId], references: [id])
  report    AuditReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([itemId])
}

model ClientRole {
  id              String   @id @default(uuid())
  name            String
  description     String?
  locationScope   String?
  departmentScope String[]
  allDepartments  Boolean  @default(false)
  permissions     Json     @default("{\"canFlag\": false, \"canView\": true, \"canReject\": false, \"canRemark\": false, \"canApprove\": false}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  users           User[]

  @@index([name])
}

model ImportLog {
  id          String    @id @default(uuid())
  filename    String
  type        String
  status      String
  totalRows   Int       @default(0)
  successRows Int       @default(0)
  errorRows   Int       @default(0)
  errors      Json?
  importedBy  String
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([importedBy])
  @@index([createdAt])
}

model SyncQueue {
  id          String       @id @default(uuid())
  userId      String
  entityType  String
  entityId    String
  action      String
  priority    SyncPriority @default(MEDIUM)
  status      SyncStatus   @default(PENDING)
  payload     Json
  attempts    Int          @default(0)
  lastError   String?
  createdAt   DateTime     @default(now())
  processedAt DateTime?
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
}

model QRGenerationJob {
  id         String    @id @default(uuid())
  baseUrl    String
  totalCount Int
  batchSize  Int       @default(500)
  status     JobStatus @default(PENDING)
  createdBy  String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  batches    QRBatch[]
  user       User      @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([status])
}

model QRBatch {
  id             String          @id @default(uuid())
  jobId          String
  batchNumber    Int
  count          Int
  status         JobStatus       @default(PENDING)
  pdfStoragePath String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  job            QRGenerationJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  tags           QRCodeTag[]

  @@index([jobId])
  @@index([status])
}

model QRBindingRecord {
  id           String        @id @default(uuid())
  qrTagId      String        @unique
  itemId       String
  itemSnapshot Json
  url          String
  boundBy      String
  boundAt      DateTime      @default(now())
  qrTag        QRCodeTag     @relation(fields: [qrTagId], references: [id])
  item         InventoryItem @relation(fields: [itemId], references: [id])
  user         User          @relation(fields: [boundBy], references: [id])

  @@index([itemId])
  @@index([boundBy])
}

model HierarchyConfig {
  level     Int      @id
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AppType {
  ADMIN
  CLIENT
  MOBILE
  WEB
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum QRTagStatus {
  UNASSIGNED
  ASSIGNED
  RETIRED
}

enum VerificationStatus {
  PENDING
  FOUND
  NOT_FOUND
  RELOCATED
  DAMAGED
  DISPOSED
}

enum ItemCondition {
  GOOD
  FAIR
  POOR
  NON_FUNCTIONAL
}

enum AuditReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  DROPDOWN
  CHECKBOX
  PHOTO
}

enum SyncPriority {
  HIGH
  MEDIUM
  LOW
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum JobStatus {
  PENDING
  GENERATING
  READY
  DOWNLOADED
  FAILED
}
