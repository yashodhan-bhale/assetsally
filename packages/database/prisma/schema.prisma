// Prisma Schema for AssetsAlly
// Asset Verification System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Enums
// ============================================================================

enum AppType {
  ADMIN
  CLIENT
  MOBILE
  WEB
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum QRTagStatus {
  UNASSIGNED
  ASSIGNED
  RETIRED
}

enum VerificationStatus {
  PENDING
  FOUND
  NOT_FOUND
  RELOCATED
  DAMAGED
  DISPOSED
}

enum ItemCondition {
  GOOD
  FAIR
  POOR
  NON_FUNCTIONAL
}

enum AuditReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  DROPDOWN
  CHECKBOX
  PHOTO
}

enum SyncPriority {
  HIGH
  MEDIUM
  LOW
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================================================
// User Management
// ============================================================================

model User {
  id                   String     @id @default(uuid())
  email                String     @unique
  passwordHash         String
  name                 String
  phone                String?
  appType              AppType
  role                 String     // e.g., SUPER_ADMIN, ADMIN, AUDITOR, or custom client roles
  status               UserStatus @default(ACTIVE)
  
  // Permission attributes
  assignedLocationId   String?
  assignedLocation     Location?  @relation("UserAssignedLocation", fields: [assignedLocationId], references: [id])
  departmentIds        String[]   // Array of department IDs
  allDepartmentsAccess Boolean    @default(false)
  
  // Client role (for CLIENT app users)
  clientRoleId         String?
  clientRole           ClientRole? @relation(fields: [clientRoleId], references: [id])
  
  // Timestamps
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  lastLoginAt          DateTime?
  
  // Relations
  auditReports         AuditReport[]    @relation("AuditorReports")
  reviewedReports      AuditReport[]    @relation("ReviewerReports")
  reportComments       ReportComment[]
  syncQueueItems       SyncQueue[]
  refreshTokens        RefreshToken[]

  @@index([email])
  @@index([appType])
  @@index([assignedLocationId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// ============================================================================
// Location Hierarchy
// ============================================================================

model Location {
  id            String    @id @default(uuid())
  code          String    @unique
  name          String
  description   String?
  
  // Materialized path for hierarchy (e.g., "ROOT.REGION1.SITE1")
  path          String
  depth         Int
  levelLabel    String    // e.g., "Region", "Site", "Building"
  
  // Parent reference
  parentId      String?
  parent        Location? @relation("LocationHierarchy", fields: [parentId], references: [id])
  children      Location[] @relation("LocationHierarchy")
  
  // Access control
  isLocked      Boolean   @default(true)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  inventoryItems    InventoryItem[]
  auditReports      AuditReport[]
  schedules         LocationSchedule[]
  assignedUsers     User[]          @relation("UserAssignedLocation")

  @@index([path])
  @@index([parentId])
  @@index([code])
}

model LocationSchedule {
  id               String   @id @default(uuid())
  locationId       String
  location         Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  scheduledDate    DateTime @db.Date
  isOverrideLocked Boolean  @default(false)  // Admin can override even scheduled access
  notes            String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([locationId, scheduledDate])
  @@index([scheduledDate])
}

// ============================================================================
// Departments
// ============================================================================

model Department {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  inventoryItems InventoryItem[]
  
  @@index([code])
}

// ============================================================================
// Asset Categories & Custom Fields
// ============================================================================

model AssetCategory {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  inventoryItems       InventoryItem[]
  customFieldDefinitions CustomFieldDefinition[]
  
  @@index([code])
}

model CustomFieldDefinition {
  id          String          @id @default(uuid())
  name        String
  label       String
  type        CustomFieldType
  required    Boolean         @default(false)
  options     Json?           // For DROPDOWN: ["Option1", "Option2"]
  order       Int             @default(0)
  
  // Category-specific (optional)
  categoryId  String?
  category    AssetCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  @@index([categoryId])
}

// ============================================================================
// Inventory Items
// ============================================================================

model InventoryItem {
  id            String       @id @default(uuid())
  code          String       @unique
  name          String
  description   String?
  
  // Location (mandatory)
  locationId    String
  location      Location     @relation(fields: [locationId], references: [id])
  
  // Department (optional)
  departmentId  String?
  department    Department?  @relation(fields: [departmentId], references: [id])
  
  // Category (optional)
  categoryId    String?
  category      AssetCategory? @relation(fields: [categoryId], references: [id])
  
  // Extended Attributes (from Excel Import)
  subCategory   String?        // Minor Category
  profitCenter  String?
  cost          Decimal?       @db.Decimal(15, 2)
  bookValue     Decimal?       @db.Decimal(15, 2)
  purchaseDate  DateTime?      // Date of Put to Use
  unitOfMeasure String?        // Column 'A' (e.g., EA)

  
  // Custom fields (JSON storage)
  customFields  Json         @default("{}")
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  qrTag         QRCodeTag?
  auditFindings AuditFinding[]
  
  @@index([locationId])
  @@index([departmentId])
  @@index([code])
}

// ============================================================================
// QR Code Tags
// ============================================================================

model QRCodeTag {
  id            String      @id @default(uuid())
  code          String      @unique
  status        QRTagStatus @default(UNASSIGNED)
  
  // Linked item (when assigned)
  linkedItemId  String?     @unique
  linkedItem    InventoryItem? @relation(fields: [linkedItemId], references: [id], onDelete: SetNull)
  
  // Batch tracking
  batchId       String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  retiredAt     DateTime?
  
  @@index([code])
  @@index([status])
  @@index([batchId])
}

// ============================================================================
// Audit Reports & Findings
// ============================================================================

model AuditReport {
  id            String            @id @default(uuid())
  
  // Location being audited
  locationId    String
  location      Location          @relation(fields: [locationId], references: [id])
  
  // Auditor
  auditorId     String
  auditor       User              @relation("AuditorReports", fields: [auditorId], references: [id])
  
  // Status
  status        AuditReportStatus @default(DRAFT)
  submittedAt   DateTime?
  
  // Review
  reviewedBy    String?
  reviewer      User?             @relation("ReviewerReports", fields: [reviewedBy], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // Timestamps
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  // Relations
  findings      AuditFinding[]
  comments      ReportComment[]
  
  @@index([locationId])
  @@index([auditorId])
  @@index([status])
}

model AuditFinding {
  id                String             @id @default(uuid())
  
  // Report reference
  reportId          String
  report            AuditReport        @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  // Item reference
  itemId            String
  item              InventoryItem      @relation(fields: [itemId], references: [id])
  
  // Core verification fields
  status            VerificationStatus @default(PENDING)
  condition         ItemCondition?
  notes             String?
  
  // Geo-tagging
  geoLat            Float?
  geoLng            Float?
  geoAccuracy       Float?
  geoTimestamp      DateTime?
  
  // Custom field values (JSON)
  customFieldValues Json               @default("{}")
  
  // Timestamps
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  photos            AuditPhoto[]
  
  @@unique([reportId, itemId])
  @@index([reportId])
  @@index([itemId])
}

model AuditPhoto {
  id               String       @id @default(uuid())
  
  findingId        String
  finding          AuditFinding @relation(fields: [findingId], references: [id], onDelete: Cascade)
  
  // Storage info
  storagePath      String
  originalFilename String
  mimeType         String
  sizeBytes        Int
  
  // Metadata
  geoLat           Float?
  geoLng           Float?
  capturedAt       DateTime?
  
  createdAt        DateTime     @default(now())
  
  @@index([findingId])
}

model ReportComment {
  id        String      @id @default(uuid())
  
  reportId  String
  report    AuditReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  // Optional: comment on specific item
  itemId    String?
  
  authorId  String
  author    User        @relation(fields: [authorId], references: [id])
  
  content   String
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  @@index([reportId])
  @@index([itemId])
}

// ============================================================================
// Client Roles & Permissions
// ============================================================================

model ClientRole {
  id              String   @id @default(uuid())
  name            String
  description     String?
  
  // Location scope (root path for access)
  locationScope   String?
  
  // Department scope
  departmentScope String[] // Array of department IDs
  allDepartments  Boolean  @default(false)
  
  // Permissions (JSON)
  permissions     Json     @default("{\"canView\": true, \"canFlag\": false, \"canRemark\": false, \"canApprove\": false, \"canReject\": false}")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  users           User[]
  
  @@index([name])
}

// ============================================================================
// Import Tracking
// ============================================================================

model ImportLog {
  id            String   @id @default(uuid())
  filename      String
  type          String   // 'locations' | 'inventory'
  status        String   // 'processing' | 'completed' | 'failed'
  totalRows     Int      @default(0)
  successRows   Int      @default(0)
  errorRows     Int      @default(0)
  errors        Json?    // Array of error details
  importedBy    String
  
  createdAt     DateTime @default(now())
  completedAt   DateTime?
  
  @@index([importedBy])
  @@index([createdAt])
}

// ============================================================================
// Mobile Sync Queue
// ============================================================================

model SyncQueue {
  id          String       @id @default(uuid())
  
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  entityType  String       // 'finding' | 'photo' | 'report'
  entityId    String
  action      String       // 'create' | 'update' | 'delete'
  priority    SyncPriority @default(MEDIUM)
  status      SyncStatus   @default(PENDING)
  
  payload     Json
  attempts    Int          @default(0)
  lastError   String?
  
  createdAt   DateTime     @default(now())
  processedAt DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([priority])
}
